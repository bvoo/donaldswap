name: Build Release

on:
  push:
    branches: [ "master", "main" ]
    tags: [ "v*.*.*" ]
  pull_request:
    branches: [ "master", "main" ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build for Windows
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        targets: x86_64-pc-windows-msvc
        
    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2
      
    - name: Build Release
      run: cargo build --release --verbose
      
    - name: Prepare artifact folder
      shell: bash
      run: |
        mkdir -p release_build
        cp target/release/donaldswap.exe release_build/
        cp -r static release_build/static/
        echo "Please launch donaldswap.exe and use http://127.0.0.1:3000" > release_build/README.txt
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: donaldswap-windows-x64
        path: release_build/
        
  release:
    name: Create GitHub Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: Download Artifact
      uses: actions/download-artifact@v4
      with:
        name: donaldswap-windows-x64
        path: release_build
        
    - name: Zip Release
      working-directory: release_build
      run: zip -r ../donaldswap-windows-x64.zip ./*
      
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: donaldswap-windows-x64.zip
        generate_release_notes: true
